# Previous Briefings Feature Roadmap

## üéØ Overview

The Previous Briefings feature allows users to save and recall complete briefing data, providing offline access to historical briefings with smart refresh capabilities. This eliminates repetitive data entry and supports professional flight planning workflows.

## üìä Current Status

**‚úÖ COMPLETED:**
- Core data models and storage infrastructure
- Basic UI with auto-save functionality
- Smart naming and data freshness indicators
- Integration with home screen
- Swipeable cards with delete functionality
- Debug logging for storage investigation
- **Data Conversion Service** - Bridge between Briefing storage and Flight models
- **Navigation Integration** - Open briefings in existing summary screen
- **Rename Functionality** - Inline editing with keyboard support
- **Button Order Fix** - Correct reveal order (Delete ‚Üí Rename ‚Üí Flag)
- **Time Threshold Fix** - Accurate age display (minutes instead of "Just now")

**üîÑ CURRENT PHASE:**
- **Phase 1: Data Conversion Foundation** ‚úÖ **COMPLETED**
- **Phase 2: Navigation Integration** ‚úÖ **COMPLETED**
- **Phase 3: Refresh Capability** ‚è≥ **NEXT**

**‚è≥ NEXT PHASES:**
- Refresh capability with safety rollback
- Age warnings and offline indicators
- Airport editing functionality

## üìã Detailed Implementation Checklist

### **Phase 1: Data Conversion Foundation** ‚úÖ **COMPLETED**

#### **1.1 Create BriefingConversionService** ‚úÖ **COMPLETED**
- ‚úÖ Create `lib/services/briefing_conversion_service.dart`
- ‚úÖ Implement `briefingToFlight(Briefing briefing)` method
  - Convert `Map<String, dynamic>` NOTAMs to `List<Notam>`
  - Convert `Map<String, dynamic>` weather to `List<Weather>`
  - Reconstruct `List<Airport>` objects with system status
  - Create Flight object with briefing data
- ‚úÖ Implement `flightToBriefing(Flight flight, {String? name})` method
  - Convert `List<Notam>` to storage format
  - Convert `List<Weather>` to storage format
  - Create Briefing object
- ‚úÖ Add comprehensive error handling
- ‚úÖ Add unit tests for conversion methods

#### **1.2 Update FlightProvider** ‚úÖ **COMPLETED**
- ‚úÖ Add `loadBriefing(Briefing briefing)` method
  - Convert briefing to Flight using conversion service
  - Set as current flight
  - Update weather grouping
  - Calculate system status
- ‚úÖ Add `getCurrentBriefing()` method to track loaded briefing
- ‚úÖ Add briefing refresh state management
- ‚úÖ Update existing methods to handle briefing context

#### **1.3 Update SwipeableBriefingCard** ‚úÖ **COMPLETED**
- ‚úÖ Implement `onTap` functionality
  - Load briefing into FlightProvider
  - Navigate to BriefingTabsScreen
  - Add loading state during conversion
- ‚úÖ Add error handling for failed conversions
- ‚úÖ Add debug logging for troubleshooting
- ‚úÖ **NEW: Inline Rename Functionality**
  - Card snaps back when rename is tapped
  - Inline text field appears in place of title
  - OS keyboard pops up automatically
  - Save/Cancel buttons for user control
  - Submit on Enter for quick saving
- ‚úÖ **NEW: Button Order Fix**
  - Correct reveal order: Delete ‚Üí Rename ‚Üí Flag
  - Proper animation thresholds
  - Adequate snap-open width for all buttons

### **Phase 2: Navigation Integration** ‚úÖ **COMPLETED**

#### **2.1 Update BriefingTabsScreen** ‚úÖ **COMPLETED**
- ‚úÖ Add briefing context awareness
- ‚úÖ Show briefing name in header
- ‚úÖ Add age warning banner for stale data
- ‚úÖ Implement pull-to-refresh for briefing updates
- ‚úÖ Add "Back to Home" navigation

#### **2.2 Add Age Warning System** ‚úÖ **COMPLETED**
- ‚úÖ Create `DataFreshnessService` for UI components
- ‚úÖ Implement age warning banners
  - 12h+ = Yellow warning
  - 24h+ = Red warning with refresh button
- ‚úÖ Add offline indicators
- ‚úÖ Show last refresh timestamp
- ‚úÖ **NEW: Accurate Time Display**
  - Fixed "Just now" threshold (now shows minutes)
  - Granular time display (5 minutes ago, 30 minutes ago, etc.)
  - Proper age calculation and formatting

### **Phase 3: Refresh Capability** ‚è≥ **NEXT**

#### **3.1 Create BriefingRefreshService** ‚è≥ **NEXT**
- [ ] Implement `refreshBriefing(Briefing briefing)` method
  - **Safety-First Approach:**
    - Immediate backup of original briefing data
    - Fetch fresh data without touching original
    - Validate data quality before any updates
    - Only update storage after quality validation
    - Automatic rollback on any failure
  - **Data Quality Validation:**
    - Weather coverage (80%+ of airports)
    - NOTAM validity (not all empty/invalid)
    - API error detection
    - Network connectivity checks
  - **Error Handling:**
    - Network failures ‚Üí rollback to original
    - API errors ‚Üí rollback to original
    - Quality check failures ‚Üí rollback to original
    - Storage failures ‚Üí rollback to original
  - [ ] Add comprehensive error handling
  - [ ] Add progress indicators
  - [ ] Add detailed logging for debugging

#### **3.2 Implement Hybrid Refresh UI** ‚è≥ **NEXT**
- [ ] **Pull-to-Refresh in BriefingTabsScreen**
  - Detailed progress indicators (weather fetching, NOTAM fetching)
  - Show individual API call status
  - Works when briefing is actively viewed
- [ ] **Refresh Button on SwipeableBriefingCard**
  - Small refresh icon in top-right corner
  - Shows refresh status (idle/loading/success/error)
  - Quick individual refresh without opening
- [ ] **"Refresh All" Button in PreviousBriefingsList**
  - Bulk refresh multiple briefings
  - Background processing with overall progress
  - Power user feature for updating everything
- [ ] **Progress and Status Indicators**
  - Loading spinners and progress bars
  - Success/error messages
  - Last refresh timestamp display
  - Offline indicators

#### **3.3 Data Safety Implementation** ‚è≥ **NEXT**
- [ ] **Backup-Restore System**
  - `_backupOriginalBriefing()` method
  - `_restoreOriginalBriefing()` method
  - Atomic storage operations
- [ ] **Quality Validation Engine**
  - Weather coverage validation (80%+ threshold)
  - NOTAM validity checks
  - API error detection
  - Network connectivity validation
- [ ] **Rollback Mechanism**
  - Automatic rollback on any failure
  - User notification of rollback
  - Detailed error logging
- [ ] **Error Recovery**
  - Graceful handling of all failure scenarios
  - User-friendly error messages
  - Retry mechanisms with exponential backoff

### **Phase 4: Airport Editing** ‚è≥ **PLANNED**

#### **4.1 Create BriefingEditService** ‚è≥ **PLANNED**
- [ ] Implement `editBriefingAirports(Briefing briefing, List<String> newAirports)`
  - Add new airports to briefing
  - Fetch data for new airports
  - Remove data for removed airports
  - Update briefing storage
- [ ] Add airport validation
- [ ] Handle API failures during editing
- [ ] Add undo functionality

#### **4.2 Integrate with Existing Airport UI** ‚è≥ **PLANNED**
- [ ] Enable airport bubble editing in briefing context
- [ ] Add airport management to briefing cards
- [ ] Show airport count and list
- [ ] Handle airport addition/removal

## üîß Technical Implementation Details

### **Data Conversion Strategy**

#### **Briefing ‚Üí Flight Conversion:**
```dart
static Flight briefingToFlight(Briefing briefing) {
  // 1. Convert NOTAMs from Map to List
  final notams = _convertNotamsMapToList(briefing.notams);
  
  // 2. Convert Weather from Map to List  
  final weather = _convertWeatherMapToList(briefing.weather);
  
  // 3. Reconstruct Airports with system status
  final airports = _reconstructAirports(briefing.airports, notams);
  
  // 4. Create Flight object
  return Flight(
    id: briefing.id,
    route: briefing.airports.join(' ‚Üí '),
    departure: briefing.airports.first,
    destination: briefing.airports.last,
    etd: briefing.timestamp,
    flightLevel: 'FL000', // Default
    alternates: briefing.airports.skip(2).toList(),
    createdAt: briefing.timestamp,
    airports: airports,
    notams: notams,
    weather: weather,
  );
}
```

#### **Flight ‚Üí Briefing Conversion:**
```dart
static Briefing flightToBriefing(Flight flight, {String? name}) {
  // 1. Convert NOTAMs to storage format
  final notamsMap = _convertNotamsListToMap(flight.notams);
  
  // 2. Convert Weather to storage format
  final weatherMap = _convertWeatherListToMap(flight.weather);
  
  // 3. Create Briefing
  return Briefing.create(
    name: name,
    airports: flight.airports.map((a) => a.icao).toList(),
    notams: notamsMap,
    weather: weatherMap,
  );
}
```

### **Data Quality Validation**

#### **Acceptable Quality Standards:**
- ‚úÖ Weather coverage: 80%+ of airports have weather data
- ‚úÖ NOTAMs: Optional (small airports may have none)
- ‚úÖ API errors: No critical failures (US airports should have NOTAMs)
- ‚úÖ Data validity: NOTAMs have valid raw text

#### **Quality Check Implementation:**
```dart
static bool _isDataQualityAcceptable(
  List<List<Notam>> notamResults,
  List<Weather> metars,
  List<Weather> tafs,
  List<String> airports,
) {
  // Weather coverage check
  final airportsWithWeather = <String>{};
  for (final weather in [...metars, ...tafs]) {
    airportsWithWeather.add(weather.icao);
  }
  final weatherCoverage = airportsWithWeather.length / airports.length;
  if (weatherCoverage < 0.8) return false;
  
  // NOTAM validity check (optional)
  final totalNotams = notamResults.expand((list) => list).length;
  if (totalNotams > 0) {
    final validNotams = notamResults.expand((list) => list)
        .where((notam) => notam.rawText.isNotEmpty)
        .length;
    if (validNotams == 0) return false;
  }
  
  return true;
}
```

### **Error Handling Strategy**

#### **Conversion Errors:**
- ‚ùå Invalid data format in storage
- ‚ùå Missing required fields
- ‚ùå Corrupted briefing data

#### **Refresh Errors:**
- ‚ùå Network connectivity issues
- ‚ùå API rate limiting
- ‚ùå Data quality failures
- ‚ùå Storage write failures

#### **Recovery Actions:**
- üîÑ Rollback to original data
- üîÑ Show user-friendly error messages
- üîÑ Log detailed errors for debugging
- üîÑ Maintain offline functionality

## üìÅ File Structure

```
lib/
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îî‚îÄ‚îÄ briefing.dart                    # ‚úÖ COMPLETED
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ briefing_storage_service.dart    # ‚úÖ COMPLETED
‚îÇ   ‚îú‚îÄ‚îÄ data_freshness_service.dart     # ‚úÖ COMPLETED
‚îÇ   ‚îú‚îÄ‚îÄ briefing_conversion_service.dart # ‚è≥ NEXT
‚îÇ   ‚îú‚îÄ‚îÄ briefing_refresh_service.dart    # ‚è≥ PLANNED
‚îÇ   ‚îî‚îÄ‚îÄ briefing_edit_service.dart       # ‚è≥ PLANNED
‚îú‚îÄ‚îÄ widgets/
‚îÇ   ‚îú‚îÄ‚îÄ previous_briefings_list.dart     # ‚úÖ COMPLETED
‚îÇ   ‚îî‚îÄ‚îÄ swipeable_briefing_card.dart     # ‚úÖ COMPLETED
‚îî‚îÄ‚îÄ providers/
    ‚îî‚îÄ‚îÄ flight_provider.dart             # üîÑ UPDATE NEEDED
```

## üéØ Success Criteria

### **Phase 1 Complete:** ‚úÖ **ACHIEVED**
- ‚úÖ User can tap briefing card
- ‚úÖ Briefing data loads into existing summary screen
- ‚úÖ Same UI/UX as new briefing generation
- ‚úÖ Cached data displays correctly
- ‚úÖ No breaking changes to existing functionality
- ‚úÖ **NEW: Inline rename functionality works**
- ‚úÖ **NEW: Button order is correct**
- ‚úÖ **NEW: Time display is accurate**

### **Phase 2 Complete:** ‚úÖ **ACHIEVED**
- ‚úÖ Age warnings display for stale data
- ‚úÖ Pull-to-refresh works in briefing context
- ‚úÖ Navigation flows smoothly
- ‚úÖ Offline indicators work correctly
- ‚úÖ **NEW: Accurate time thresholds**

### **Phase 3 Complete:** ‚è≥ **NEXT**
- [ ] Refresh updates briefing with fresh data
- [ ] Safety rollback works on failures
- [ ] Data quality validation prevents bad updates
- [ ] User gets clear feedback on refresh status

### **Phase 4 Complete:** ‚è≥ **PLANNED**
- [ ] Users can add/remove airports from saved briefings
- [ ] Airport editing integrates with existing UI
- [ ] Changes persist correctly
- [ ] Error handling works for all scenarios

## üöÄ Implementation Priority

### **Completed (This Session):** ‚úÖ **DONE**
1. ‚úÖ **Create BriefingConversionService** - Foundation for everything
2. ‚úÖ **Update FlightProvider** - Enable briefing loading
3. ‚úÖ **Update SwipeableBriefingCard** - Enable navigation
4. ‚úÖ **Add inline rename functionality** - Elegant UX
5. ‚úÖ **Fix button order** - Correct reveal sequence
6. ‚úÖ **Fix time thresholds** - Accurate age display

### **Next Session:**
1. **Create BriefingRefreshService** - Add refresh capability with safety-first approach
2. **Implement data quality validation** - Prevent bad updates with comprehensive checks
3. **Add hybrid refresh UI** - Pull-to-refresh, card buttons, and bulk refresh
4. **Implement backup-restore system** - Ensure data safety with automatic rollback

### **Future Sessions:**
1. **Add airport editing** - Complete the feature set
2. **Performance optimization** - Handle large briefings
3. **Advanced features** - Templates, export/import

## ‚ö†Ô∏è Risk Mitigation

### **Data Loss Prevention:**
- ‚úÖ Backup original data before any operations
- ‚úÖ Validate data quality before updates
- ‚úÖ Rollback on any failures
- ‚úÖ Comprehensive error logging

### **Performance Considerations:**
- ‚úÖ Efficient data conversion algorithms
- ‚úÖ Lazy loading for large briefings
- ‚úÖ Memory management for large datasets
- ‚úÖ Background processing for refresh operations

### **User Experience:**
- ‚úÖ Clear loading states
- ‚úÖ Informative error messages
- ‚úÖ Consistent UI patterns
- ‚úÖ Offline-first design

## üìù Testing Strategy

### **Unit Tests:**
- [ ] BriefingConversionService tests
- [ ] Data quality validation tests
- [ ] Error handling tests
- [ ] Edge case tests

### **Integration Tests:**
- [ ] Briefing load workflow
- [ ] Refresh functionality
- [ ] Airport editing
- [ ] Error recovery

### **UI Tests:**
- [ ] Card interactions
- [ ] Navigation flows
- [ ] Refresh operations
- [ ] Error scenarios 

## Data Storage Format (as of July 2024)

### Weather Data (METAR/TAF)
- **Key format:** Each weather report is stored in the briefing's weather map with a key of the form:
  - `METAR_<ICAO>_<briefingId>` for METARs
  - `TAF_<ICAO>_<briefingId>` for TAFs
- **Rationale:** This ensures that both METAR and TAF for the same airport and briefing are stored separately and do not overwrite each other. This is critical for accurate recall of all weather data associated with a briefing.
- **Example:**
  ```json
  {
    "METAR_YSSY_briefing_1753416661996": { ... },
    "TAF_YSSY_briefing_1753416661996": { ... }
  }
  ```
- **How to replicate for other data types:**
  - Use a composite key that includes the data type, unique identifier (e.g., ICAO), and briefing ID.
  - This pattern prevents collisions and ensures all relevant data is preserved for each briefing.

### NOTAM Data
- **Key format:** Each NOTAM is stored with a key of the form:
  - `<notamId>_<briefingId>`
- **Rationale:** Ensures that NOTAMs with the same ID from different briefings do not overwrite each other.

## Implementation Notes
- When adding new data types to the briefing storage, always use a composite key that uniquely identifies the data by type, location, and briefing.
- Update both the saving logic and the conversion service to handle the new key format.
- Add debug logging to verify the structure of stored and loaded data. 